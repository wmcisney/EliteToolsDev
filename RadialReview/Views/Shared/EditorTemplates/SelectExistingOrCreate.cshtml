@model RadialReview.Utilities.SelectExistingOrCreateUtility.SelectExistingOrCreate

@{
	var guid = Guid.NewGuid().ToString().Replace("-", "");

	var createAvailable = true;
	if (Model.ShowCreate == false) {
		Model.ShowCreateFirst = false;
		createAvailable = false;
	}

}

<div class="seoc seoc-@guid">
	<input type="hidden" class="seoc-selectpage" name="SelectPage" value="@(!Model.ShowCreateFirst)" />
	@if (createAvailable) {
		<span class="seoc-alt-btn"><span class="btn btn-link"></span></span>
	}
	<div class="seoc-panel">
		<div class="seoc-existing hidden">
			<b>@(Model.SelectInstructions)</b>
			<select class="seoc-select" name="@Html.NameFor(x => x.SelectedValue)" @{ if (Model.Multiple) { @: multiple="multiple"
					} }></select>
		</div>
		@if (createAvailable) {
			<div class="seoc-create hidden">
				<div class="s-panel">
					<div class="panel-body">
						@Html.EditorFor(x => x.Object, Model.Template)
					</div>
				</div>
			</div>
		}
	</div>
</div>




<style>
	.seoc-@guid{
		width:100%;
		display:inline-block;
	}

	.seoc-@guid .seoc-panel{
		/*width:90%;
		width:calc(100% - 169px);*/
		width:100%;
		display:inline-block;
		float:left;
	}


	.seoc-@guid .seoc-panel .s-panel{
		-webkit-box-shadow: none;
		box-shadow: none;
	}

	.seoc-@guid .seoc-existing select {
		width:100%;
	    padding: 9px 9px 8px 9px;
		border-radius: 4px;
		border: 1px solid #ccc;
		color:#888;
	}

	.seoc-@guid .seoc-existing .select2 {
		width:100% !important;
	}

	.seoc-@guid .seoc-existing .select2-container .select2-selection__rendered{
		/*padding-left:2px;*/
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--single .select2-selection__rendered {
		line-height: 32px;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--single .select2-selection__clear {
		cursor: pointer;
		float: right;
		font-weight: bold;
		background-color: #ccc;
		width: 60px;
		height: 18px;
		margin-top: 7px;
		color: white;
		line-height: 18px;
		text-align: right;
		padding-right: 6px;
		border-radius: 5px;
		transition:.15s ease background;
	}

	.select2-results__option.loading-results ~ .select2-results__option{
		display:none;
	}
	.select2-results__option.loading-results:before{
		content:"Loading...";
		position:relative;
		top:10px;
	}


	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--single .select2-selection__clear:hover {
		background-color: #7b7b7b;
	}


	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--single .select2-selection__clear:before{
		content: "CLEAR";
		font-size: 11px;
		padding-right: 4px;
		top: -1px;
		position: relative;
		color: #eee;
	}

	@*Multiple selections*@
	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .select2-selection__rendered{
		padding-right:10px;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .searchresult-image{
		display:inline-block;
		margin:2px;
		margin-left: -2px;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .searchresult-image .picture{
		border-radius:16px;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .select2-selection__choice{
		line-height:0px;
		border-radius: 19px;
		background: #efefef;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .select2-selection__clear{
		/*margin-right: -15px;*/
		margin-top:15px;
		margin-bottom: 8px;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .select2-search__field{
		margin-top: 13px;
		margin-bottom: 7px;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .searchresult-title{
		margin-right: 6px;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .select2-selection__choice__remove{
		margin-right: 6px;
		margin-left: 4px;
		float: right;
	}

	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .select2-selection__choice__remove,
	.seoc-@guid .seoc-existing .select2-container--default .select2-selection--multiple .searchresult-title{
		line-height: 34px;
		margin-top: 2px;
	}

	.seoc-@guid .seoc-create .panel-body{
		padding:9px 11px;
	}

	.seoc-@guid {
		min-height:38px;
	}

	.seoc-@guid .seoc-alt-btn {
		float:left;
	    position: absolute;
		top: -18px;
		right: 0px;
	}

	.seoc-@guid .seoc-alt-btn .btn{
        font-weight:bold !important;
	}
	.seoc-@guid .seoc-alt-btn .btn-link{
		background-color: #5bc0de;
		color: white;
		text-decoration: none;
		height: 22px !important;
		line-height:2px;
		border-radius: 12px !important;
		width: auto;
		/*margin-right: 17px !important;
		margin-bottom: -13px !important;*/
		margin-right: 42px !important;
		margin-TOP: -46px !important;
		font-size: 11px;
		border:2px solid transparent !important;
		-webkit-transition:background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1), border 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
	    transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1), border 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
		text-transform: uppercase;
	}

	.seoc-@guid .seoc-alt-btn .btn:hover{
		background-color:white;
		color:#5bc0de;
		/*text-decoration:underline;*/
		/*font-style: italic;*/
		border:2px solid #5bc0de !important;
	}

	.seoc-@guid .select2-search__field {
		min-width: 140px!important;
	}

	@*.seoc-@guid .select2-container .select2-selection--single{
		height:28px !important;
	}*@


</style>
<script>
	function a@(guid)() {
		//$.getScript("https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.js").done(function () {

			var container = $(".seoc-@guid");

			var settings = {
				showCreate: @Model.ShowCreateFirst.ToJavascript(),
				searchUrl:  "@Model.SearchUrl",
			};

			var hiddenPage;


			var template = function (d) {
				var des = "";
				var org = "";
				var name = "";
				var img = "";
				var altIcon = "";

				if (typeof (d.Name) === "string")
					name = d.Name;

				if (typeof (d.Description) === "string")
					des = " " + d.Description;

				if (typeof (d.ImageUrl) === "string")
					img = profilePicture(d.ImageUrl, name);
				if (typeof (d.AltIcon) === "string")
					img = d.AltIcon;


				var markup = "<div class='searchresult-image'>" + img + "</div>" +
							  "<div class='searchresult-meta'>" +
								"<div class='searchresult-title'>" + name + "</div>" +
								"<div class='searchresult-description'>" + des + "</div>" +
							  "</div>"+
							  "<div class='searchresult-alticon'>" + altIcon + "</div>";

				return markup;
			};

			var select2 = container.find(".seoc-existing .seoc-select").select2({
				closeOnSelect: true,
				allowClear: true,
				placeholder:  "Search for existing..." ,
				//selectOnClose: true,
				ajax: {
					url: settings.searchUrl,
					dataType: 'json',
					//minimumInputLength: Model.MinimumInputLength,
					delay: 450,
					data: function (params) {
						return {
							search: params.term,
							q:params.term,
						};
					},
					processResults: function (data, page) {
						if (data.Object){
							data = data.Object;
						}

						data.forEach(function (d, i) {
							d.id = d.ItemValue;
						});

						//data.push({
						//	Name: "Create New...",
						//	ItemValue: '!!new',
						//})

						return {
							results: data
						};
					},
					cache: true
				},
				escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
				minimumInputLength: 1,
				templateResult: function (d) {
					return "<div><div class='searchresult clearfix' data-value='" + d.ItemValue + "'>" + template(d) + "</div></div>";
				},
				templateSelection: function (d) {
					return "<div class='searchresult searchresult-selected'>" + template(d) + "</div>";
				}
			}).on("change", function (e) {
				//console.info($(this).select2('data')[0].Name);
				//$("[@@(nameAttr + "Text")]").val($(this).select2('data')[0].Name);
			});
			$(select2).on('select2:open', function (e) {
				var o = $(container).find(".seoc-existing .select2");
				//setTimeout(function(){
				var loc = /*o.offset().top+o.height() -*/ parseInt($("html").css("padding-top"));
				$("body>.select2-container").css("margin-top",-loc);
				//},0);

			});


			var select2_open;
			// open select2 dropdown on focus
			$(".seoc-@guid").on('focus', '.select2-selection--single', function(e) {
				select2_open = $(this).parent().parent().siblings('select');
				select2_open.select2('open');
			});

			// fix for ie11
			if (/rv:11.0/i.test(navigator.userAgent)) {
				$(".seoc-@guid").on('blur', '.select2-search__field', function (e) {
					select2_open.select2('close');
				});
			}


			function adjustPage(){
				var container = $(".seoc-@guid");
				//.toggleClass("hidden",settings.showCreate);
				//$(container).find(".seoc-create").toggleClass("hidden",!settings.showCreate);
				var text = "";
				if (settings.showCreate){
					var tempHidden = hiddenPage;
					hiddenPage = $(container).find(".seoc-existing").detach();
					if (tempHidden){
						$(container).find(".seoc-panel").append(tempHidden);
					}
					//text = "or select existing"; //<span class='glyphicon glyphicon-star' style='color:#005ed7'> </span>
					text = "Or " + "@(HttpUtility.JavaScriptStringEncode(Model.SelectTitle??"Or select existing"))";
					$(container).find(".seoc-selectpage").val("false");
					$("#modalTitle").html("@(HttpUtility.JavaScriptStringEncode(Model.CreateTitle??"Create"))");
					$("body").trigger("seoc-page", { page: "create" });

				}else{
					var tempHidden = hiddenPage;
					hiddenPage = $(container).find(".seoc-create").detach();
					if (tempHidden){
						$(container).find(".seoc-panel").append(tempHidden);
					}
					text = "or create new"; //<span class='glyphicon glyphicon-star' style='color:#005ed7'></span>
					$(container).find(".seoc-selectpage").val("true");
					$("#modalTitle").html("@(HttpUtility.JavaScriptStringEncode(Model.SelectTitle??"Select existing"))");
					$("body").trigger("seoc-page", { page: "select" });

				}

				container.find(".seoc-alt-btn .btn").html(text);
			}


			container.find(".seoc-alt-btn .btn").click(function(){
				settings.showCreate=!settings.showCreate;
				adjustPage();
			});

			$(container).find(".seoc-existing,.seoc-create").removeClass("hidden");
			adjustPage();


		//});
	}

	function defer@(guid)() {
		if (window.jQuery)
			a@(guid)();
		else
			setTimeout(function () { defer@(guid)() }, 50);
	}
	defer@(guid)();
</script>